_format_version: "3.0"
_comment: "Kong Gateway configuration for Docker Production Environment"

# ------------------------------------------------------------------------------
# SERVICIOS: Define los microservicios backend usando IPs internas de Docker
# ------------------------------------------------------------------------------
services:
  # --- Servicio ms-usuarios ---
  - name: service-usuarios
    url: http://ms-usuarios:3010
    protocol: http
    connect_timeout: 5000
    read_timeout: 60000
    write_timeout: 60000
    retries: 3

    routes:
      - name: usuarios-auth
        paths:
          - /api/v1/auth
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: usuarios-users
        paths:
          - /api/v1/users
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: usuarios-roles
        paths:
          - /api/v1/roles
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: usuarios-permissions
        paths:
          - /api/v1/permissions
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

  # --- Servicio ms-eventos ---
  - name: service-eventos
    url: http://ms-eventos:3005
    protocol: http
    connect_timeout: 5000
    read_timeout: 60000
    write_timeout: 60000
    retries: 3

    routes:
      - name: eventos-events
        paths:
          - /api/v1/events
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: eventos-categories
        paths:
          - /api/v1/categories
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: eventos-venues
        paths:
          - /api/v1/venues
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: eventos-status
        paths:
          - /eventos/status
        strip_path: true
        methods:
          - GET

  # --- Servicio ms-tickets ---
  - name: service-tickets
    url: http://ms-tickets:3000
    protocol: http
    connect_timeout: 5000
    read_timeout: 120000
    write_timeout: 120000
    retries: 3

    routes:
      - name: tickets-cart
        paths:
          - /api/v1/cart
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: tickets-orders
        paths:
          - /api/v1/orders
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: tickets-tickets
        paths:
          - /api/v1/tickets
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: tickets-event-ticket-types
        paths:
          - /api/v1/events/.*/ticket-types
        strip_path: false
        regex_priority: 1
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: tickets-status
        paths:
          - /tickets/status
        strip_path: true
        methods:
          - GET

  # --- Servicio ms-notifications ---
  - name: service-notifications
    url: http://ms-notifications:3001
    protocol: http
    connect_timeout: 5000
    read_timeout: 60000
    write_timeout: 60000
    retries: 3

    routes:
      - name: notifications-status
        paths:
          - /api/v1/health
        strip_path: true
        methods:
          - GET

# ------------------------------------------------------------------------------
# WEBSOCKET ROUTES
# ------------------------------------------------------------------------------
  # WebSocket para ms-tickets
  - name: websocket-tickets
    url: http://ms-tickets:3000
    protocol: http

    routes:
      - name: ws-tickets
        paths:
          - /ws-tickets
        strip_path: true
        preserve_host: false
        protocols:
          - http
          - https

  # WebSocket para ms-eventos
  - name: websocket-eventos
    url: http://ms-eventos:3005
    protocol: http

    routes:
      - name: ws-eventos
        paths:
          - /ws-eventos
        strip_path: true
        preserve_host: false
        protocols:
          - http
          - https

  # WebSocket para ms-notifications
  - name: websocket-notifications
    url: http://ms-notifications:3001
    protocol: http

    routes:
      - name: ws-notifications
        paths:
          - /ws-notifications
        strip_path: true
        preserve_host: false
        protocols:
          - http
          - https

# ------------------------------------------------------------------------------
# PLUGINS GLOBALES
# ------------------------------------------------------------------------------
plugins:
  - name: cors
    config:
      origins:
        - "http://localhost:709"
        - "http://127.0.0.1:709"
        - "http://frontend:3000"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
      exposed_headers:
        - X-Auth-Token
      credentials: true
      max_age: 3600
      preflight_continue: false