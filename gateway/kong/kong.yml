_format_version: "3.0"
_comment: "Configuraci칩n de Kong como API Gateway y balanceador de carga con formato /api/v1/ticketslave/"

# ------------------------------------------------------------------------------
# SERVICIOS: Define los microservicios backend
# ------------------------------------------------------------------------------
services:
  # --- Servicio ms-tickets ---
  - name: service-tickets
    url: http://host.docker.internal:3000
    protocol: http
    connect_timeout: 5000
    read_timeout: 60000
    write_timeout: 60000
    retries: 3

    routes:
      - name: tickets-cart
        paths:
          - /api/v1/cart
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: tickets-orders
        paths:
          - /api/v1/orders
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: tickets-tickets
        paths:
          - /api/v1/tickets
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: tickets-ticket-types
        paths:
          - ~/api/v1/events/\d+/ticket-types
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: tickets-websocket
        paths:
          - /ws-tickets
        strip_path: true
        protocols:
          - http
          - https

  # --- Servicio ms-usuarios ---
  - name: service-users
    url: http://host.docker.internal:3010
    protocol: http
    connect_timeout: 5000
    read_timeout: 30000
    write_timeout: 30000
    retries: 3

    routes:
      - name: usuarios-auth
        paths:
          - /api/v1/auth
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: usuarios-users
        paths:
          - /api/v1/users
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: usuarios-roles
        paths:
          - /api/v1/roles
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: usuarios-permissions
        paths:
          - /api/v1/permissions
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

  # --- Servicio ms-eventos ---
  - name: service-events
    url: http://host.docker.internal:3005
    protocol: http
    connect_timeout: 5000
    read_timeout: 30000
    write_timeout: 30000
    retries: 3

    routes:
      - name: eventos-events
        paths:
          - /api/v1/events
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: eventos-categories
        paths:
          - /api/v1/categories
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: eventos-venues
        paths:
          - /api/v1/venues
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
      - name: eventos-websocket
        paths:
          - /ws-eventos
        strip_path: true
        protocols:
          - http
          - https
      - name: eventos-status
        paths:
          - /eventos/status
        strip_path: false
        methods:
          - GET
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: "/status"

  # --- Servicio ms-notifications ---
  - name: service-notifications
    url: http://host.docker.internal:3001
    protocol: http
    connect_timeout: 5000
    read_timeout: 30000
    write_timeout: 30000
    retries: 3

    routes:
      - name: notifications-health
        paths:
          - /api/v1/health
        strip_path: false
        methods:
          - GET
      - name: notifications-websocket
        paths:
          - /ws-notifications
        strip_path: true
        protocols:
          - http
          - https

# ------------------------------------------------------------------------------
# PLUGINS GLOBALES: Solo configuraci칩n b치sica de CORS
# ------------------------------------------------------------------------------
plugins:
  # --- CORS b치sico ---
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-Type
        - Date
        - Authorization
        - X-Requested-With
      credentials: true
      max_age: 3600
