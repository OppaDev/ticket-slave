_format_version: "3.0"
_comment: "Configuración declarativa para la plataforma de venta de tickets."

# ------------------------------------------------------------------------------
# SERVICIOS: Define los microservicios backend a los que Kong enrutará el tráfico.
# ------------------------------------------------------------------------------
services:
  # --- Servicio para ms-tickets ---
  - name: service-tickets
    url: http://host.docker.internal:3000
    protocol: http
    connect_timeout: 5000
    read_timeout: 60000  # Incrementado para operaciones de pago
    write_timeout: 60000
    retries: 3
    
    routes:
      # --- Health Check (Público) ---
      - name: route-tickets-health
        paths:
          - /health
        strip_path: false
        methods:
          - GET
        
      # --- API Info (Público) ---
      - name: route-tickets-info
        paths:
          - /api/v1
        strip_path: false
        methods:
          - GET
          
      # --- Eventos (Público - solo lectura) ---
      - name: route-events-public
        paths:
          - /api/v1/events
        strip_path: false
        methods:
          - GET
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              policy: local
        
      # --- Gestión de Tipos de Ticket (Requiere autenticación de admin) ---
      - name: route-ticket-types
        paths:
          - /api/v1/events/~/ticket-types
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-Gateway-Source:kong"
          
      # --- Carrito de Compras (Requiere autenticación de usuario) ---
      - name: route-cart
        paths:
          - /api/v1/cart
        strip_path: false
        methods:
          - GET
          - POST
          - DELETE
        plugins:
          - name: jwt
            config:
              secret_is_base64: false
              claims_to_verify:
                - exp
                - iat
              key_claim_name: iss
              maximum_expiration: 3600
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-User-Id:{{jwt.claim.user_id}}"
                  - "X-User-Context:authenticated"
                  
      # --- Pedidos (Requiere autenticación y rate limiting estricto) ---
      - name: route-orders
        paths:
          - /api/v1/orders
        strip_path: false
        methods:
          - GET
          - POST
        plugins:
          - name: jwt
            config:
              secret_is_base64: false
              claims_to_verify:
                - exp
                - iat
              key_claim_name: iss
              maximum_expiration: 3600
          - name: rate-limiting
            config:
              minute: 10   # Máximo 10 pedidos por minuto
              hour: 100    # Máximo 100 pedidos por hora
              policy: local
          - name: request-size-limiting
            config:
              allowed_payload_size: 1  # 1MB máximo para datos de pedido
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-User-Id:{{jwt.claim.user_id}}"
              
      # --- Gestión de Entradas (Requiere autenticación) ---
      - name: route-tickets
        paths:
          - /api/v1/tickets
        strip_path: false
        methods:
          - GET
          - POST  # Para check-in
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1000
              policy: local

      # --- Ruta catch-all para otras API calls ---
      - name: route-tickets-api
        paths:
          - /api
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1000
              policy: local

# ------------------------------------------------------------------------------
# PLUGINS GLOBALES: Se aplican a todas las rutas
# ------------------------------------------------------------------------------
plugins:
  # --- Seguridad Global ---
  - name: cors
    config:
      origins:
        - "http://localhost:3000"
        - "http://localhost:8080"
        - "https://yourdomain.com"  # Reemplaza con tu dominio
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        - X-Requested-With
      exposed_headers:
        - X-Auth-Token
      credentials: true
      max_age: 3600

  # --- Logging Global ---
  - name: file-log
    config:
      path: /tmp/access.log
      reopen: true

  # --- Rate Limiting Global (menos restrictivo) ---
  - name: rate-limiting
    config:
      minute: 100
      hour: 2000
      policy: local
      fault_tolerant: true

  # --- Request/Response Transformation ---
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Gateway:Kong"
          - "X-Service:ms-tickets"

# ------------------------------------------------------------------------------
# CONFIGURACIÓN ADICIONAL PARA PRODUCCIÓN
# ------------------------------------------------------------------------------
# Uncomment estas secciones según necesites:

# --- Plugin de Autenticación JWT (Descomenta cuando implementes auth) ---
# - name: jwt
#   config:
#     secret_is_base64: false
#     claims_to_verify:
#       - exp
#       - iat
#     key_claim_name: iss
#     maximum_expiration: 3600

# --- Plugin de Prometheus para métricas (Recomendado para monitoreo) ---
# - name: prometheus
#   config:
#     per_consumer: true
#     status_code_metrics: true
#     latency_metrics: true
#     bandwidth_metrics: true

# --- Plugin de Circuit Breaker para alta disponibilidad ---
# - name: request-termination
#   config:
#     status_code: 503
#     message: "Service temporarily unavailable"