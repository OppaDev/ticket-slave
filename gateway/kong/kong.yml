_format_version: "3.0"
_comment: "Configuración de Kong como API Gateway y balanceador de carga con formato /api/v1/ticketslave/"

# ------------------------------------------------------------------------------
# SERVICIOS: Define los microservicios backend
# ------------------------------------------------------------------------------
services:
  # --- Servicio ms-tickets ---
  - name: service-tickets
    url: http://host.docker.internal:3000
    protocol: http
    connect_timeout: 5000
    read_timeout: 60000
    write_timeout: 60000
    retries: 3

    routes:
      # --- Rutas de tickets (cart, orders, tickets) ---
      - name: route-tickets-cart
        paths:
          - /api/v1/ticketslave/cart
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

      - name: route-tickets-orders
        paths:
          - /api/v1/ticketslave/orders
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

      - name: route-tickets-tickets
        paths:
          - /api/v1/ticketslave/tickets
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

  # --- Servicio ms-usuarios ---
  - name: service-users
    url: http://host.docker.internal:3010
    protocol: http
    connect_timeout: 5000
    read_timeout: 30000
    write_timeout: 30000
    retries: 3

    routes:
      # --- Rutas de autenticación ---
      - name: route-users-auth
        paths:
          - /api/v1/ticketslave/auth
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

      # --- Rutas de usuarios ---
      - name: route-users-users
        paths:
          - /api/v1/ticketslave/users
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

      # --- Rutas de roles ---
      - name: route-users-roles
        paths:
          - /api/v1/ticketslave/roles
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

      # --- Rutas de permisos ---
      - name: route-users-permissions
        paths:
          - /api/v1/ticketslave/permissions
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

  # --- Servicio ms-eventos ---
  - name: service-events
    url: http://host.docker.internal:3005
    protocol: http
    connect_timeout: 5000
    read_timeout: 30000
    write_timeout: 30000
    retries: 3

    routes:
      # --- Rutas de eventos ---
      - name: route-events-events
        paths:
          - /api/v1/ticketslave/events
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

      # --- Rutas de categorías ---
      - name: route-events-categories
        paths:
          - /api/v1/ticketslave/categories
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

      # --- Rutas de venues ---
      - name: route-events-venues
        paths:
          - /api/v1/ticketslave/venues
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

      # --- Rutas de tipos de ticket (anidadas) ---
      - name: route-tickets-ticket-types
        paths:
          - /api/v1/ticketslave/events
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS

# ------------------------------------------------------------------------------
# PLUGINS GLOBALES: Solo configuración básica de CORS
# ------------------------------------------------------------------------------
plugins:
  # --- CORS básico ---
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-Type
        - Date
        - Authorization
        - X-Requested-With
      credentials: true
      max_age: 3600
